"use strict";function _createForOfIteratorHelper(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var a=0,e=function(){};return{s:e,n:function(){return a>=t.length?{done:!0}:{done:!1,value:t[a++]}},e:function(t){throw t},f:e}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,i=!0,r=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return i=t.done,t},e:function(t){r=!0,o=t},f:function(){try{i||null==n.return||n.return()}finally{if(r)throw o}}}}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,a=new Array(e);n<e;n++)a[n]=t[n];return a}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var a=e[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),t}function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var Puock=function(){function t(){_classCallCheck(this,t),_defineProperty(this,"data",{tag:"puock",params:{home:null,vd_comment:!1,vd_vid:null,use_post_menu:!1,is_single:!1,is_pjax:!1},vdInstance:null,comment:{loading:!1,time:5,val:null,replyId:null}})}return _createClass(t,[{key:"onceInit",value:function(){var e=this;this.pageInit(),$(document).on("click",".fancybox",function(){return!1}),$(document).on("click","#return-top-bottom>div",function(t){t="top"===$(e.ct(t)).attr("data-to")?0:window.document.body.clientHeight;$("html,body").animate({scrollTop:t},800)}),$(document).on("click",".colorMode",function(){e.modeChange(null,!0)}),this.data.params.is_pjax&&this.instanceClickLoad(),this.sidebarMenuEventInit(),this.eventOpenSearchBox(),this.eventShareStart(),this.modeInit(),this.registerMobileMenuEvent(),this.registerModeChangeEvent(),this.eventCommentPageChangeEvent(),this.eventCommentPreSubmit(),this.eventSmiley(),this.eventOpenCommentBox(),this.eventCloseCommentBox(),this.eventSendPostLike(),this.eventPostMainBoxResize()}},{key:"pageInit",value:function(){this.loadParams(),this.data.params.vd_comment&&this.loadVaptcha(),this.initReadProgress(),this.pageChangeInit(),this.data.params.is_single&&(this.data.params.use_post_menu&&this.generatePostMenuHTML(),this.generatePostQrcode(),this.initCodeHighlight())}},{key:"ct",value:function(t){return t.currentTarget}},{key:"eventOpenSearchBox",value:function(){$(document).on("click",".search-modal-btn",function(){var t=$("#search"),e="true"===t.attr("data-open"),n=e?"Out":"In";t.attr("class","animated fade"+n+"Left"),$("#search-backdrop").attr("class","modal-backdrop animated fade"+n+"Right"),t.attr("data-open",!e)})}},{key:"eventShareStart",value:function(){var o=this;$(document).on("click",".share-to>div",function(t){t=$(o.ct(t)).attr("data-id");if("wx"!==t){var e=window.location.href,n=$("#post-title").text(),a=null;switch(t){case"wb":a="https://service.weibo.com/share/share.php?pic=&title="+n+"&url="+e+"&appkey=";break;case"qzone":a="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?title="+n+"&url="+e;break;case"tw":a="https://twitter.com/intent/tweet?url="+e;break;case"fb":a="https://www.facebook.com/sharer.php?u"+e}window.open(a,"_blank")}})}},{key:"sidebarMenuEventInit",value:function(){var n=this;$(document).on("touchend","#post-menu-state",function(t){t.preventDefault(),n.toggleMenu()}),$(document).on("click","#post-menu-state",function(){n.toggleMenu()}),$(document).on("click",".pk-menu-to",function(t){var e=$(n.ct(t)).attr("href"),t=$("#header").innerHeight();return $("html, body").animate({scrollTop:$(e).offset().top-t-10+"px"},{duration:500,easing:"swing"}),!1})}},{key:"toggleMenu",value:function(){var t=$("#post-menu-state"),e="data-open",n=t.hasClass(e),a=$("#post-menu-content");n?(a.hide(),t.removeClass(e)):(a.show(),t.addClass(e))}},{key:"lazyLoadInit",value:function(){void 0!==window.LazyLoad&&new window.LazyLoad(document.querySelectorAll([0<arguments.length&&void 0!==arguments[0]?arguments[0]:".lazyload","[data-lazy=true]"]),{root:null,rootMargin:"0px",threshold:0})}},{key:"loadParams",value:function(){this.data.params=JSON.parse($("meta[name='puock-params']").attr("content")),this.data.commentVd="on"===this.data.params.vd_comment}},{key:"loadVaptcha",value:function(){var e=this;void 0!==vaptcha&&vaptcha({vid:this.data.params.vd_vid,type:"invisible",scene:3,offline_server:"http://ww.ss",area:"cn"}).then(function(t){e.data.vdInstance=t,e.data.vdInstance.listen("pass",function(){$("#comment-vd").val(e.data.vdInstance.getToken()),e.data.vdInstance.reset(),$.comment_form_submit_exec($("#comment-form"))})})}},{key:"initReadProgress",value:function(){var e=$("#page-read-progress .progress-bar");document.addEventListener("scroll",function(){var t=window.scrollY/(document.documentElement.scrollHeight-window.innerHeight)*100;e.attr("style","width:"+t.toFixed(0)+"%")})}},{key:"pageChangeInit",value:function(){document.getElementById("post-main")&&new Viewer(document.getElementById("post-main"),{navbar:!1,filter:function(t){return!$(t).hasClass("dont-view")&&t.complete}}),$('[data-toggle="tooltip"]').tooltip({placement:"auto",trigger:"hover"}),this.data.params.is_single&&new ClipboardJS(".copy-post-link",{text:function(){var t=$(".copy-post-link");return t.find("span").html("已复制"),t.attr("disabled",!0),setTimeout(function(){t.find("span").html("复制链接"),t.attr("disabled",!1)},3e3),location.href}}),this.lazyLoadInit()}},{key:"getPostMenuStructure",value:function(){var t,e=[],n=_createForOfIteratorHelper($(".entry-content").find("h1,h2,h3,h4,h5,h6"));try{for(n.s();!(t=n.n()).done;){var a=t.value;e.push({name:$(a).text().trim(),level:a.tagName.toLowerCase(),id:$(a).attr("id")})}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"generatePostMenuHTML",value:function(){var t=this.getPostMenuStructure(),e="<ul>";if(0<t.length){for(var n=6,a=0;a<t.length;a++){var o=parseInt(t[a].level[1]);o<n&&(n=o)}for(var i=0;i<t.length;i++){var r=t[i],l=0,c=parseInt(r.level[1]);e+="<li style='padding-left:".concat(l=n<c?10*(c-n):l,"px' class='t-line-1'><i class='czs-angle-right-l t-sm c-sub mr-1'></i><a class='pk-menu-to a-link t-w-400 t-md' href='#").concat(r.id,"'>").concat(r.name,"</a></li>")}}e+="</ul>",$("#post-menu-content").html(e)}},{key:"initCodeHighlight",value:function(){void 0!==window.hljs&&document.querySelectorAll("pre").forEach(function(t){window.hljs.highlightBlock(t)})}},{key:"generatePostQrcode",value:function(){void 0!==window.QRCode&&window.QRCode.toDataURL(window.location.href,{errorCorrectionLevel:"H"},function(t,e){t||$("#wx-share").attr("data-original-title","<p class='text-center t-sm mb-1 mt-1'>使用微信扫一扫</p><img class='mb-1' alt='微信二维码' src='".concat(e,"'/>"))})}},{key:"localstorageToggle",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return null!=e?localStorage.setItem(t,e):localStorage.getItem(t)}},{key:"loadCommentInfo",value:function(){var t=this.localstorageToggle("comment_author"),e=this.localstorageToggle("comment_email"),n=this.localstorageToggle("comment_url");null!=t&&null!=e&&($("#author").val(t),$("#email").val(e),$("#url").val(n))}},{key:"setCommentInfo",value:function(){this.localstorageToggle("comment_author",$("#author").val()),this.localstorageToggle("comment_email",$("#email").val()),this.localstorageToggle("comment_url",$("#url").val())}},{key:"asyncCacheViews",value:function(t){$.post(this.data.params.home+"/wp-admin/admin-ajax.php?action=async_pk_views",{id:t},function(t){0!==t.code?console.error(t.msg):$("#post-views").text(t.data)},"json").error(function(t){console.error(t)})}},{key:"instanceClickLoad",value:function(){var t=this;InstantClick.init("mousedown"),InstantClick.on("change",function(){t.modeInit(),t.pageChangeInit(),t.loadCommentInfo(),t.initCodeHighlight()}),this.loadCommentInfo()}},{key:"modeInit",value:function(){var t=this.localstorageToggle("light");void 0!==t&&this.modeChange(t)}},{key:"modeChange",value:function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null,e=1<arguments.length&&void 0!==arguments[1]&&arguments[1],n=$("body");null===(t="string"==typeof t?"true"===t:t)&&(t=n.hasClass(this.data.tag+"-light"));var a="d-none";(t=e?!t:t)?($("#logo-light").removeClass(a),$("#logo-dark").addClass(a)):($("#logo-dark").removeClass(a),$("#logo-light").addClass(a)),n.removeClass(t?this.data.tag+"-dark":this.data.tag+"-light"),n.addClass(t?this.data.tag+"-light":this.data.tag+"-dark"),this.localstorageToggle("light",t),Cookies.set("mode",t?"light":"dark")}},{key:"modeChangeListener",value:function(){this.modeChange(!window.matchMedia("(prefers-color-scheme:dark)").matches)}},{key:"registerModeChangeEvent",value:function(){try{window.matchMedia("(prefers-color-scheme:dark)").addEventListener("change",this.modeChangeListener)}catch(t){window.matchMedia("(prefers-color-scheme:dark)").addListener(this.modeChangeListener)}}},{key:"infoToastShow",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"提示",n=$("#infoToast");$("#infoToastTitle").html(e),$("#infoToastText").html(t),n.modal("show")}},{key:"registerMobileMenuEvent",value:function(){function t(t){"string"!=typeof t&&(t="Out"),$("#mobile-menu").attr("class","animated fade"+t+"Left"),$("#mobile-menu-backdrop").attr("class","modal-backdrop animated fade"+t+"Right")}$(document).on("click","#mobile-menu-backdrop",t),$(document).on("click",".mobile-menu-close",t),$(document).on("click",".mobile-menu-s",function(){t("In")})}},{key:"gotoCommentArea",value:function(){$("html,body").animate({scrollTop:$("#comments").offset().top},800),this.lazyLoadInit()}},{key:"pushAjaxCommentHistoryState",value:function(t){history.pushState({foo:"bar"},"page 2",t)}},{key:"eventCommentPageChangeEvent",value:function(){var o=this;$(document).on("click",".comment-ajax-load a.page-numbers",function(t){var e=$("#post-comments"),n=$("#comment-ajax-load");$("#comment-cancel").click();var a=$(o.ct(t)).attr("href");return o.pushAjaxCommentHistoryState(a),e.html(" "),n.removeClass("d-none"),$.post(a,{},function(t){e.html($(t).find("#post-comments")),n.addClass("d-none"),o.gotoCommentArea()}).error(function(){location=a}),!1})}},{key:"eventCommentPreSubmit",value:function(){var e=this;$(document).on("submit","#comment-form",function(t){return"0"!==$("#comment-logged").val()||""!==$.trim($("#author").val())&&""!==$.trim($("#email").val())?""===$.trim($("#comment").val())?e.infoToastShow("评论内容不能为空"):e.data.params.vd_comment&&e.data.vdInstance?e.data.vdInstance.validate():e.commentSubmit(e.ct(t)):e.infoToastShow("评论信息不能为空"),!1})}},{key:"commentSubmit",value:function(t){var a=this,e=$("#comment-form").attr("action");this.commentFormLoadStateChange(),$.ajax({url:e,data:$(t).serialize(),type:$(t).attr("method"),success:function(t){var e,n;a.infoToastShow("评论已提交成功"),$("#comment").val(""),null!=a.data.comment.replyId?(0===(n=(e=$("#comment-"+a.data.comment.replyId)).find(".children")).length&&(e.append("<ul class='children'></ul>"),n=e.find(".children")),n.prepend(t)):$("#post-comments").prepend(t),$("#comment-cancel").click(),a.commentFormLoadStateChange(),a.setCommentInfo()},error:function(t){a.commentFormLoadStateChange(),a.infoToastShow(t.responseText)}})}},{key:"commentFormLoadStateChange",value:function(){var t=this,e=$("#comment-submit");this.data.comment.loading?(e.html("请等待"+this.data.comment.time+"s"),this.data.comment.val=setInterval(function(){t.data.comment.time<=1?(clearInterval(t.data.comment.val),e.html("提交评论"),e.removeAttr("disabled"),t.data.comment.time=5):(--t.data.comment.time,e.html("请等待"+t.data.comment.time+"s"))},1e3)):(e.html('<span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span>提交中...'),e.attr("disabled",!0)),this.data.comment.loading=!this.data.comment.loading}},{key:"eventOpenCommentBox",value:function(){var n=this;$(document).on("click","[id^=comment-reply-]",function(t){var e;n.data.comment.replyId=$(n.ct(t)).attr("data-id"),""!==$.trim(n.data.comment.replyId)?(e=$("#comment-form"),t=$("#comment-box-"+n.data.comment.replyId),e.addClass("box-sw"),t.removeClass("d-none").append(e),$("#comment-cancel").removeClass("d-none"),$("#comment").val(""),$("#comment_parent").val(n.data.comment.replyId)):n.infoToastShow("结构有误")})}},{key:"eventCloseCommentBox",value:function(){var n=this;$(document).on("click","#comment-cancel",function(){var t=$("#comment-form"),e=$("#comment-box-"+n.data.comment.replyId);t.removeClass("box-sw"),e.addClass("d-none"),$("#comment-form-box").append(t),$("#comment-cancel").addClass("d-none"),n.data.comment.replyId=null})}},{key:"eventSendPostLike",value:function(){var n=this;$(document).on("click","#post-like",function(t){var e=$(n.ct(t)),t=e.attr("data-id");$.post("/wp-admin/admin-ajax.php",{action:"puock_like",um_id:t,um_action:"like"},function(t){0===t.e?(e.find("span").html(t.d),e.addClass("bg-primary text-light")):n.infoToastShow(t.t)},"json").error(function(){n.infoToastShow("点赞异常")})})}},{key:"eventSmiley",value:function(){var n=this,a="#twemoji";$(document).on("click","#comment-smiley",function(){$(a).modal("show")}),$(document).on("click",".smiley-img",function(t){var e=$("#comment");e.val(e.val()+" "+$(n.ct(t)).attr("data-id")+" "),$(a).modal("hide")})}},{key:"eventPostMainBoxResize",value:function(){$(document).on("click",".post-main-size",function(){var t=$("#post-main"),e=$("#sidebar"),n=t.hasClass("col-lg-8");t.removeClass(n?"col-lg-8":"col-lg-12"),t.addClass(n?"col-lg-12":"col-lg-8"),n?e.removeClass("d-lg-block"):e.addClass("d-lg-block")})}}]),t}();$(function(){window.Pucok=new Puock,window.Pucok.onceInit()});